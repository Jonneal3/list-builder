<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Industry Explorer</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; margin: 24px; }
    input, button { padding: 8px; margin-right: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f5f5f5; text-align: left; }
    .muted { color: #666; }
    .pill { display: inline-block; background: #eef; color: #224; padding: 4px 8px; border-radius: 999px; margin: 2px; font-size: 12px; }
  </style>
</head>
<body>
  <h1>AI Industry Explorer</h1>
  <div>
    <input id="industry" placeholder="e.g., nail salons" style="width:320px" />
    <button id="planBtn">Plan</button>
    <button id="startBtn" disabled>Run Search</button>
  </div>

  <div id="plan" style="margin-top: 12px" class="muted"></div>

  <table id="results">
    <thead>
      <tr><th>Event</th><th>Directory</th><th>Angle</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    const planBtn = document.getElementById('planBtn');
    const startBtn = document.getElementById('startBtn');
    const industryInput = document.getElementById('industry');
    const planDiv = document.getElementById('plan');
    const tbody = document.getElementById('tbody');

    let plan = null;
    let jobId = null;

    function renderPlan(p) {
      const dirs = p.directories.slice(0, 20).map(d => `<span class="pill">${d}</span>`).join('');
      const angs = p.angles.slice(0, 10).map(a => `<span class="pill">${a}</span>`).join('');
      planDiv.innerHTML = `<div><strong>Directories</strong><div>${dirs}</div><strong>Angles</strong><div>${angs}</div></div>`;
    }

    planBtn.onclick = async () => {
      const industry = industryInput.value.trim();
      if (!industry) return;
      planDiv.textContent = 'Planning…';
      const res = await fetch('/plan', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ industry }) });
      if (!res.ok) { planDiv.textContent = 'Planner unavailable – start Ollama'; return; }
      plan = await res.json();
      renderPlan(plan);
      startBtn.disabled = false;
    };

    startBtn.onclick = async () => {
      if (!plan) return;
      tbody.innerHTML = '';
      const industry = industryInput.value.trim();
      const res = await fetch('/search/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ industry, directories: plan.directories, angles: plan.angles }) });
      if (!res.ok) { alert('Failed to start'); return; }
      const data = await res.json();
      jobId = data.job_id;
      const es = new EventSource(`/search/stream/${jobId}`);
      es.onmessage = (e) => {
        try {
          const msg = JSON.parse(e.data);
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${msg.type}</td><td>${msg.directory || ''}</td><td>${msg.angle || ''}</td>`;
          tbody.prepend(tr);
        } catch {}
      };
      es.addEventListener('done', () => es.close());
    };
  </script>
</body>
</html>
